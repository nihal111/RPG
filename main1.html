

<!DOCTYPE html>
<html>
  <head>
<script type="text/javascript">window.NREUM||(NREUM={});NREUM.info={"beacon":"bam.nr-data.net","errorBeacon":"bam.nr-data.net","licenseKey":"3af4913bb7","applicationID":"9998535","transactionName":"dg1bTEFfXA1WQksURVwBXmdARFETR0NLFlhaFQ==","queueTime":0,"applicationTime":43,"agent":""}</script>
<script type="text/javascript">window.NREUM||(NREUM={}),__nr_require=function(e,t,n){function r(n){if(!t[n]){var o=t[n]={exports:{}};e[n][0].call(o.exports,function(t){var o=e[n][1][t];return r(o||t)},o,o.exports)}return t[n].exports}if("function"==typeof __nr_require)return __nr_require;for(var o=0;o<n.length;o++)r(n[o]);return r}({QJf3ax:[function(e,t){function n(){}function r(e){function t(e){return e&&e instanceof n?e:e?a(e,i,o):o()}function s(n,r,o){e&&e(n,r,o);for(var i=t(o),a=l(n),u=a.length,f=0;u>f;f++)a[f].apply(i,r);var s=c[w[n]];return s&&s.push([h,n,r,i]),i}function p(e,t){g[e]=l(e).concat(t)}function l(e){return g[e]||[]}function d(e){return f[e]=f[e]||r(s)}function v(e,t){u(e,function(e,n){t=t||"feature",w[n]=t,t in c||(c[t]=[])})}var g={},w={},h={on:p,emit:s,get:d,listeners:l,context:t,buffer:v};return h}function o(){return new n}var i="nr@context",a=e("gos"),u=e(1),c={},f={},s=t.exports=r();s.backlog=c},{1:12,gos:"7eSDFh"}],ee:[function(e,t){t.exports=e("QJf3ax")},{}],3:[function(e,t){function n(e,t){return function(){r(e,[(new Date).getTime()].concat(i(arguments)),null,t)}}var r=e("handle"),o=e(1),i=e(2);"undefined"==typeof window.newrelic&&(newrelic=NREUM);var a=["setPageViewName","addPageAction","setCustomAttribute","finished","addToTrace","inlineHit"],u=["addPageAction"],c="api-";o(a,function(e,t){newrelic[t]=n(c+t,"api")}),o(u,function(e,t){newrelic[t]=n(c+t)}),t.exports=newrelic,newrelic.noticeError=function(e){"string"==typeof e&&(e=new Error(e)),r("err",[e,(new Date).getTime()])}},{1:12,2:13,handle:"D5DuLP"}],gos:[function(e,t){t.exports=e("7eSDFh")},{}],"7eSDFh":[function(e,t){function n(e,t,n){if(r.call(e,t))return e[t];var o=n();if(Object.defineProperty&&Object.keys)try{return Object.defineProperty(e,t,{value:o,writable:!0,enumerable:!1}),o}catch(i){}return e[t]=o,o}var r=Object.prototype.hasOwnProperty;t.exports=n},{}],handle:[function(e,t){t.exports=e("D5DuLP")},{}],D5DuLP:[function(e,t){function n(e,t,n,o){r.buffer([e],o),r.emit(e,t,n)}var r=e("ee").get("handle");t.exports=n,n.ee=r},{ee:"QJf3ax"}],XL7HBI:[function(e,t){function n(e){var t=typeof e;return!e||"object"!==t&&"function"!==t?-1:e===window?0:i(e,o,function(){return r++})}var r=1,o="nr@id",i=e("gos");t.exports=n},{gos:"7eSDFh"}],id:[function(e,t){t.exports=e("XL7HBI")},{}],G9z0Bl:[function(e,t){function n(){if(!v++){var e=d.info=NREUM.info,t=f.getElementsByTagName("script")[0];if(e&&e.licenseKey&&e.applicationID&&t){u(p,function(t,n){e[t]||(e[t]=n)});var n="https"===s.split(":")[0]||e.sslForHttp;d.proto=n?"https://":"http://",a("mark",["onload",i()],null,"api");var r=f.createElement("script");r.src=d.proto+e.agent,t.parentNode.insertBefore(r,t)}}}function r(){"complete"===f.readyState&&o()}function o(){a("mark",["domContent",i()],null,"api")}function i(){return(new Date).getTime()}var a=e("handle"),u=e(1),c=window,f=c.document;NREUM.o={ST:setTimeout,XHR:c.XMLHttpRequest,REQ:c.Request,EV:c.Event,PR:c.Promise,MO:c.MutationObserver},e(2);var s=(""+location).split("?")[0],p={beacon:"bam.nr-data.net",errorBeacon:"bam.nr-data.net",agent:"js-agent.newrelic.com/nr-885.min.js"},l=window.XMLHttpRequest&&XMLHttpRequest.prototype&&XMLHttpRequest.prototype.addEventListener&&!/CriOS/.test(navigator.userAgent),d=t.exports={offset:i(),origin:s,features:{},xhrWrappable:l};f.addEventListener?(f.addEventListener("DOMContentLoaded",o,!1),c.addEventListener("load",n,!1)):(f.attachEvent("onreadystatechange",r),c.attachEvent("onload",n)),a("mark",["firstbyte",i()],null,"api");var v=0},{1:12,2:3,handle:"D5DuLP"}],loader:[function(e,t){t.exports=e("G9z0Bl")},{}],12:[function(e,t){function n(e,t){var n=[],o="",i=0;for(o in e)r.call(e,o)&&(n[i]=t(o,e[o]),i+=1);return n}var r=Object.prototype.hasOwnProperty;t.exports=n},{}],13:[function(e,t){function n(e,t,n){t||(t=0),"undefined"==typeof n&&(n=e?e.length:0);for(var r=-1,o=n-t||0,i=Array(0>o?0:o);++r<o;)i[r]=e[t+r];return i}t.exports=n},{}]},{},["G9z0Bl"]);</script>
    <title>Kandy | Make a Video Call</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <meta name="csrf-param" content="authenticity_token" />
    <meta name="csrf-token" content="jcsErriQuavm6dAXW4mRvMjVdEhsTdSzSD3EA3dSWMLCCoVdyX5QDSVCVjsgPFwWPoIHqOD7u96TYc2uXfj13Q==" />
    <link rel="shortcut icon" type="image/x-icon" href="https://developer.kandy.io/assets/favicon-4e6cd320f5d3961133e0a2def7b91e6f.ico" />

    <!--Load Bootstrap CSS (optional)-->
    <link rel="stylesheet" media="screen" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css" />
    <link rel="stylesheet" media="screen" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap-theme.min.css" />

    <!--Load Kandy JS files --><script src="https://code.jquery.com/jquery-1.7.2.min.js"></script>
    <script src="https://kandy-portal.s3.amazonaws.com/public/javascript/kandy/2.5.0/kandy.js"></script>

    <!--Load Pace AJAX Progress Bar (optional)-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.0.2/pace.min.js"></script>
    <link rel="stylesheet" media="screen" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.0.2/themes/pink/pace-theme-minimal.css" />

    <script type="text/javascript">
      $(function() {
        var callId, username;

        // Create audio objects to play incoming calls and outgoing calls sound
      var $audioRingIn = $('<audio>', { loop: 'loop', id: 'ring-in' });
      var $audioRingOut = $('<audio>', { loop: 'loop', id: 'ring-out' });

      // Load audio source to DOM to indicate call events
      var audioSource = {
        ringIn: [
          { src: 'https://kandy-portal.s3.amazonaws.com/public/sounds/ringin.mp3', type: 'audio/mp3' },
          { src: 'https://kandy-portal.s3.amazonaws.com/public/sounds/ringin.ogg', type: 'audio/ogg' }
          ],
        ringOut: [
          { src: 'https://kandy-portal.s3.amazonaws.com/public/sounds/ringout.mp3', type: 'audio/mp3' },
          { src: 'https://kandy-portal.s3.amazonaws.com/public/sounds/ringout.ogg', type: 'audio/ogg' }]
      };

      audioSource.ringIn.forEach(function(entry) {
        var $source = $('<source>').attr('src', entry.src);
        $audioRingIn.append($source);
      });

      audioSource.ringOut.forEach(function(entry) {
        var $source = $('<source>').attr('src', entry.src);
        $audioRingOut.append($source);
      });

        /** setup(config) intializes kandy
          @param <object> config
        */
        kandy.setup({

          remoteVideoContainer: $('#incoming-video')[0],
          localVideoContainer: $('#outgoing-video')[0],
          // listeners registers events to handlers
          // You can handle all Kandy Events by registering it here
          listeners: {
            callinitiated: onCallInitiate,
            callinitiatefailed: onCallInitiateFail,
            callincoming: onCallIncoming,
        	callestablished: onCallEstablished,
            oncall: onCall,
            callended: onCallTerminate,
            callendfailed: onCallEndedFailed
          }
        });

       var username, UIState = {};

      UIState.authenticated = function() {
        $('#login-form').addClass('hidden');
        $('#logged-in').removeClass('hidden');
        $('.username').text(username);
      };

      UIState.unauthenticated = function() {
        $('#login-form').removeClass('hidden');
        $('#logged-in').addClass('hidden');
        $('.username').text('');
      };

      UIState.initial = function() {
        console.log('initial');

        $audioRingIn[0].pause();
        $audioRingOut[0].pause();

        $('#call-form p, #incoming-call p, #call-connected p').text('');
        $('#incoming-call, #call-connected, .call-terminator, #resume-call-btn').addClass('hidden');
        $('#call-form, .call-initializer').removeClass('hidden')
      };

      var toCall = false;

      	  // Event handler for callinitiate
      function onCallInitiate(call) {
        callId = call.getId();

        $audioRingIn[0].pause();
        $audioRingOut[0].play();

        $('#username-calling').text('Calling ' + $('#user_to_call').val());
        UIState.callinitialized();
      }

      // Event handler for callinitiatefail event
      function onCallInitiateFail() {
        console.log("call initiate fail");

        $audioRingOut[0].pause();
        UIState.initial();
        alert('call failed');
      }

      UIState.callinitialized = function() {
        console.log("Call Initialised");

        $('.call-initializer').addClass('hidden');
      };// Event handler for initiate call button
      $('#initialize-call-btn').on('click', function() {
        var username = $('#user_to_call').val();

        /** makeCall( userName, cameraOn ) : Void
            Initiates a call to another Kandy user over web
            @params <string> userName, <boolean> cameraOn
        */
        kandy.call.makeCall(username, true);
      });
        // Event handler for oncall event
      function onCall(call) {
        console.log("OnCall");
        $audioRingOut[0].pause();
        UIState.oncall();
      }

      // Event handler for callended event
      function onCallTerminate(call) {
        console.log("Cancelled");
        callId = null;

        $audioRingOut[0].play();
        $audioRingIn[0].pause();

        UIState.initial();
      }


        // What to do for an incoming call.
		function onCallIncoming(call) {
		    console.log("Incoming call from " + call.callerNumber);

		    // Store the call id, so the callee has access to it.
		    callId = call.getId();
		    kandy.call.answerCall(callId, true);

		    // Handle UI changes. A call is incoming.
		    document.getElementById("accept-call").disabled = false;
		    document.getElementById("decline-call").disabled = false;

		}

		function onCallEstablished(call) {
		    console.log("Call established.");

		    // Handle UI changes. Call in progress.
		    document.getElementById("make-call").disabled = true;
		    document.getElementById("mute-call").disabled = false;
		    document.getElementById("hold-call").disabled = false;
		    document.getElementById("end-call").disabled = false;

        setTimeout(function(){window.location.href='index2.html'},30000);
		}



        // Event handler for callendedfailed event
        function onCallEndedFailed() {
           console.debug('callendfailed');
           callId = null;
        }

        // What to do on a successful login.
		function onLoginSuccess() {
		    console.log("Login was successful.");
        if(toCall) {
          $("#initialize-call-btn").click();
        }
		}

		// What to do on a failed login.
		function onLoginFailure() {
		    console.log("Login failed. Make sure you input the user's credentials!");
		}

        projectAPIKey = "DAK37713725dc7242e9acda3d88e68aa132";

        function loadData() {
		   var account = localStorage.getItem('_account');
		   if (!account)
		   {
		    username="arpan"
		    password="nihal111"
		   }
		   else
		   {
          //decodes a string data encoded using base-64
          account = atob(account);
          //parses to Object the JSON string
          account = JSON.parse(account);
          //do what you need with the Object
          username=account.User;
          password=account.Pass;
        }
        console.log("loading "+username+" "+password);
        $('#username').text(username);
        kandy.login(projectAPIKey, username, password, onLoginSuccess, onLoginFailure);

        var users = ["", 'arpan', 'nihal', 'trehan', 'cheeku'];
        if(username == 'arpan')
          var data = {stage:'1', index:'1'}
        if(username == 'nihal')
          var data = {stage:'1', index:'2'}
        if(username == 'trehan')
          var data = {stage:'1', index:'3'}
        if(username == 'cheeku')
          var data = {stage:'1', index:'4'}

        $.ajax({
          url:'http://www.kibo.in/app/test',
          method: 'get',
          crossDomain: true,
          dataType: 'jsonp',
          callback: 'callback',
          data:data,
          success:function(data) {
            json_string = JSON.stringify(data);
            json = JSON.parse(json_string);
            console.log("first="+json.first);
            console.log("second="+json.second);
            if(username == users[parseInt(json.first)]) {
              toCall = true;
              if(users[parseInt(json.second)] == 'arpan') {
                $("#user_to_call").val("arpan@ferozepur.gmail.com");
              }
              if(users[parseInt(json.second)] == 'nihal') {
                $("#user_to_call").val("nihal@ferozepur.gmail.com");
              }
              if(users[parseInt(json.second)] == 'trehan') {
                $("#user_to_call").val("trehan@ferozepur.gmail.com");
              }
              if(users[parseInt(json.second)] == 'cheeku') {
                $("#user_to_call").val("cheeku@ferozepur.gmail.com");
              }
            }
          }
        });

		}
        window.onload = loadData;

        /** UIState is a custom piece of code that shuffles between UI states
          eg:: If user is authenticated, the relevant DOM elements are brought to screen
          and the rest are hidden. Using this method is NOT recommended!
      */

      $('#logout-btn').on('click', function(e) {
        e.preventDefault();
        /** logout(success) logs a user out of the Kandy Platform
            @param <function> success - Callback handler for
            successful logout
        */
        kandy.logout(function() {
          userArray.push(username);
          kandy.getLastSeen(userArray);
          UIState.unauthenticated();
        });
      });

      $('#hold-call-btn').on('click', function() {
        kandy.call.holdCall(callId);
        UIState.holdcall();
      });

      $('#resume-call-btn').on('click', function() {
        kandy.call.unHoldCall(callId);
        UIState.resumecall();
      });

      // Event handler for call end button
      $('#end-call-btn').on('click', function() {
        kandy.call.endCall(callId);
        UIState.initial();
      });

      UIState.oncall = function() {
        console.log('oncall');

        $('#incoming-call, #call-form').addClass('hidden');
        $('#call-connected').removeClass('hidden');
      };

      UIState.holdcall = function() {
        console.log('holdcall');

        $('#hold-call-btn').addClass('hidden');
        $('#resume-call-btn').removeClass('hidden');
      };

      UIState.resumecall = function() {
        console.log('resumecall');

        $('#hold-call-btn').removeClass('hidden');
        $('#resume-call-btn').addClass('hidden');
      };

      });
    </script>
  </head>
  <body>
    <div class="container">
      <div class="row">
        <div class="col-xs-8 col-xs-offset-2" id="activity-container">

          <div class="visible" id="logged-in">
            <hr />
            <div class="clearfix">
              <p class="h4 pull-left">
                <strong>Hello <span class="username"></span></strong>
              </p>
              <button class="btn btn-danger pull-right" id="logout-btn">Logout</button>
            </div>
            <hr />
            <div id="video-container">
              <h3>
                Video
              </h3>
              <div class="row">
                <div class="col-sm-6">
                  <div class="video" id="incoming-video"></div>
                </div>
                <div class="col-sm-6">
                  <div class="video" id="outgoing-video"></div>
                </div>
              </div>
            </div>
            <hr /><div id="call-form">
              <h4>
                Make a Call
              </h4>
              <p id="username-calling"></p>
              <div class="form-group call-initializer">
                <label for="user_to_call">Enter Callee Username</label>
                <input type="text" name="user_to_call" id="user_to_call" class="form-control" placeholder="name@company.com" />

              </div>
              <div class="form-group call-initializer">
                <button class="btn btn-success" id="initialize-call-btn">Call</button>
              </div>
              <div class="form-group call-terminator hidden">
                <button class="btn btn-danger" id="initialize-end-btn">End Call</button>
              </div>
            </div><div class="hidden" id="call-connected">
              <h4>
                Call Connected
              </h4>
              <p id="username-connected"></p>
              <div class="btn-toolbar">
                <button class="btn btn-danger" id="end-call-btn">End Call</button><button class="btn btn-warning" id="hold-call-btn">Hold Call</button><button class="btn btn-success hidden" id="resume-call-btn">Resume Call</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <br><br>
    <center><button class="btn btn-success" onclick="location.href='index2'">Proceed</button></center>
  </body>
</html>